<script>
/**
 * 카드 리스트 렌더링 전용 스크립트 (페이지네이션 제거 버전)
 * - localStorage / diaryUtils 에서 카드 데이터를 로드
 * - mood(감정) / 검색어 필터 적용
 * - map()으로 HTML 문자열 생성 후 .body-card-list 에 주입
 */
(function () {
  // 외부 유틸(존재 시)에서 필요한 것만 구조분해
  const { moodMapMedium, buildCardsFromDiaries, loadDiaries } =
    (window.diaryUtils || {});

  /**
   * 1) 저장소에서 카드 데이터 로드
   * - 우선 diaryUtils의 loadDiaries() + buildCardsFromDiaries() 시도
   * - 없으면 localStorage.diaryCardsData 키(직접 저장된 카드형 데이터) 시도
   * - 그래도 없으면 샘플 카드 생성
   */
  function loadFromLocalStorageOrBuildSamples() {
    // diaryUtils 기반 로드
    const diaries = typeof loadDiaries === "function" ? loadDiaries() : [];
    const cards = typeof buildCardsFromDiaries === "function" ?
      buildCardsFromDiaries(diaries) : [];

    if (Array.isArray(cards) && cards.length) return cards;

    // diaryCardsData 키에 카드형 데이터가 직접 저장된 경우 호환
    try {
      const rawCards = localStorage.getItem("diaryCardsData");
      if (rawCards) {
        const parsed = JSON.parse(rawCards);
        if (Array.isArray(parsed) && parsed.length) {
          return parsed;
        }
      }
    } catch (_) {}

    // 아무 데이터도 없으면 샘플 카드 반환
    return buildSampleCards(12);
  }

  /**
   * 2) 샘플 카드 생성
   * - moodMapMedium이 있으면 해당 매핑을 사용하여 이미지/컬러/태그 등 구성
   */
  function buildSampleCards(count = 12) {
    const moods =
      (window.diaryUtils && window.diaryUtils.moods) || [
        "행복해요",
        "슬퍼요",
        "놀랐어요",
        "화나요",
        "기타",
      ];

    return Array.from({ length: count }, (_, i) => {
      const mood = moods[i % moods.length];
      const map =
        (moodMapMedium && moodMapMedium[mood]) ||
        (moodMapMedium && moodMapMedium["기타"]) ||
        {};
      return {
        id: `sample-${i}`,
        title: `타이틀 영역 입니다. #${i + 1}`,
        date: "2024. 03. 12",
        tagId: map.tagId || "tag-etc",
        tag: map.tag || mood || "기타",
        image: map.image || "./public/images/sample.png",
        color: map.color || "#F5F5F5",
      };
    });
  }

  /**
   * 3) 전역 카드 데이터 접근기
   * - 실제 데이터가 있으면 그걸 반환, 없으면 샘플 반환
   */
  window.cardData = {
    getItem(key) {
      if (key !== "diaryCardsData") return null;
      const fromStorage = loadFromLocalStorageOrBuildSamples();
      if (Array.isArray(fromStorage) && fromStorage.length) return fromStorage;
      return buildSampleCards(12);
    },
  };

  /**
   * 4) 렌더 함수: mood / 검색어 필터 → map으로 HTML 생성 → DOM 주입
   * - filterMood: "all" | 특정 감정 문자열(예: "행복해요")
   * - window.currentSearchTerm: 외부에서 입력 이벤트로 채워지는 검색어
   */
  function renderCards(filterMood = "all") {
    const listEl = document.querySelector(".body-card-list");
    const emptyEl = document.querySelector(".body-contents-undefined-data");
    if (!listEl) return;

    // 데이터 읽기
    const data =
      window.cardData && Array.isArray(cardData.getItem("diaryCardsData"))
        ? cardData.getItem("diaryCardsData")
        : [];

    // 4-1) mood 필터
    let filtered =
      filterMood && filterMood !== "all"
        ? data.filter((card) => card.tag === filterMood)
        : data;

    // 4-2) 검색어(제목 기준) 필터
    const term = (window.currentSearchTerm || "").trim();
    if (term) {
      const lower = term.toLowerCase();
      filtered = filtered.filter((card) =>
        String(card.title || "").toLowerCase().includes(lower)
      );
    }

    // 현재 필터 상태를 전역에 저장(다른 UI 스크립트에서 참조 가능)
    window.currentFilter = filterMood;

    // 4-3) 비어있는 경우 UI 처리
    if (!filtered.length) {
      listEl.innerHTML = "";
      listEl.style.display = "none";
      if (emptyEl) emptyEl.style.display = "flex";
      return;
    }

    // 4-4) map()으로 카드 HTML 문자열 생성
    const cardsHTML = filtered
      .map(
        (card, index) => `
          <a class="diary-card-link" href="./cardDetail.html?id=${encodeURIComponent(
            card.id
          )}">
            <div class="diary-card" data-index="${index}">
              <div class="diary-card-image">
                <button class="diary-card-delete-button" onclick="deleteCard(event, '${
                  card.id
                }')">
                  <img src="./public/icons/light/close_outline_light_m.svg" alt="삭제">
                </button>
                <img class="diary-card-main-image" src="${card.image}" alt="일기 이미지">
              </div>
              <div class="diary-card-content">
                <div class="card-tag-date-wrapper">
                  <p id="${card.tagId}" class="card-tag body-regular-14">${card.tag}</p>
                  <p class="diary-card-date body-regular-14">${card.date}</p>
                </div>
                <p class="diary-card-title title-bold-18">${card.title}</p>
              </div>
            </div>
          </a>
        `
      )
      .join("");

    // 4-5) DOM 반영
    listEl.innerHTML = cardsHTML;
    listEl.style.display = "grid";
    if (emptyEl) emptyEl.style.display = "none";
  }

  // 렌더 함수를 전역에 노출(다른 스크립트에서 호출 가능)
  window.renderCards = renderCards;

  /**
   * 5) 최초 진입 시 자동 렌더링
   * - index 페이지 등 .body-card-list가 존재하는 곳에서만 실행
   */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.querySelector(".body-card-list")) {
      renderCards();
    }
  });
})();
</script>
